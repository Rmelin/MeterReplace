{% extends "base.html" %}
{% block content %}
<section class="page-header">
    <div>
        <h1>Mine opgaver</h1>
        <p>Arbejdsdage med opgaver og status.</p>
    </div>
</section>

<section class="card">
    <h2>Arbejdsdag</h2>
    {% if availability_dates %}
        <form method="get" action="/vvs/tasks" class="form-grid">
            <label>
                Dato
                <select name="date_query" required>
                    {% for day in availability_dates %}
                        <option value="{{ day.isoformat() }}" {% if selected_date and day == selected_date %}selected{% endif %}>
                            {{ day.strftime('%d/%m/%Y') }}
                        </option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit" class="primary-button">Vælg dag</button>
        </form>
        {% if selected_date %}
            <p class="hint" style="margin-top: 0.5rem;">Status: {{ done_count }}/{{ total_count }} færdige</p>
        {% endif %}
    {% else %}
        <p class="hint">Ingen arbejdsdage registreret endnu.</p>
    {% endif %}
</section>

<section class="card">
    <h2>To do</h2>
    {% if todo %}
        {% for appointment in todo %}
            {% set address = addresses.get(appointment.id) %}
            <div class="card task-card{% if not address %} task-no-address{% endif %}">
                <div class="task-head">
                    {% if address %}
                        <h3>{{ address.street }} {{ address.house_no }}, {{ address.zip }} {{ address.city }}</h3>
                    {% else %}
                        <h3>Opgave uden adresse</h3>
                        <span class="task-flag">Opgave uden adresse</span>
                    {% endif %}
                </div>
                <p class="hint">{{ appointment.starts_at.strftime('%d/%m %H:%M') }} – {{ appointment.ends_at.strftime('%H:%M') }}</p>
                {% if appointment.notes %}
                    <p class="hint">Opgave: {{ appointment.notes }}</p>
                {% endif %}
                {% if address and address.buffer_flag and address.buffer_note %}
                    <p class="hint">Placering af målerbrønd: {{ address.buffer_note }}</p>
                {% endif %}
                <a class="link" href="/vvs/tasks/{{ appointment.id }}/edit" data-inline-edit-trigger="{{ appointment.id }}">Rediger</a>
                <div class="inline-edit is-hidden" data-inline-edit="{{ appointment.id }}"></div>
                {% if address %}
                    <form method="post" action="/vvs/tasks/{{ appointment.id }}/photos" enctype="multipart/form-data" class="form-grid">
                        <input type="hidden" name="date_query" value="{{ selected_date.isoformat() if selected_date else '' }}" />
                        <fieldset class="option-field" required>
                            <legend>Fototype</legend>
                            <div class="option-buttons">
                                <label class="option-button">
                                    <input type="radio" name="photo_type" value="both" required />
                                    <span>Begge målere i ét foto</span>
                                </label>
                                <label class="option-button">
                                    <input type="radio" name="photo_type" value="new" required />
                                    <span>Ny måler</span>
                                </label>
                                <label class="option-button">
                                    <input type="radio" name="photo_type" value="old" required />
                                    <span>Gammel måler</span>
                                </label>
                            </div>
                        </fieldset>
                        <label>Gammel målernr<input type="text" name="old_meter_no" /></label>
                        <label>Ny målernr<input type="text" name="new_meter_no" /></label>
                        <label>Foto<input type="file" name="file" accept="image/*" required /></label>
                        <button type="submit" class="primary-button">Upload</button>
                    </form>
                    {% if photos.get(appointment.id) %}
                        <div class="photo-grid">
                            {% for photo in photos.get(appointment.id) %}
                                <div class="photo-item">
                                    <img src="/upload/{{ photo.file_path }}" alt="{{ photo_labels.get(photo.photo_type, photo.photo_type) }}" class="photo-thumb" />
                                    <span>{{ photo_labels.get(photo.photo_type, photo.photo_type) }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="hint">Ingen fotos endnu.</p>
                    {% endif %}
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <p class="hint">Ingen opgaver på dagen.</p>
    {% endif %}
</section>

<section class="card">
    <h2>Done</h2>
    {% if done %}
        {% for appointment in done %}
            {% set address = addresses.get(appointment.id) %}
            <div class="card task-card{% if not address %} task-no-address{% endif %}">
                <div class="task-head">
                    {% if address %}
                        <h3>{{ address.street }} {{ address.house_no }}, {{ address.zip }} {{ address.city }}</h3>
                    {% else %}
                        <h3>Opgave uden adresse</h3>
                        <span class="task-flag">Opgave uden adresse</span>
                    {% endif %}
                </div>
                <p class="hint">{{ appointment.starts_at.strftime('%d/%m %H:%M') }} – {{ appointment.ends_at.strftime('%H:%M') }}</p>
                <p class="hint">Status: {{ status_labels.get(appointment.status, appointment.status.value) }}</p>
                {% if appointment.notes %}
                    <p class="hint">Opgave: {{ appointment.notes }}</p>
                {% endif %}
                <a class="link" href="/vvs/tasks/{{ appointment.id }}/edit" data-inline-edit-trigger="{{ appointment.id }}">Rediger</a>
                <div class="inline-edit is-hidden" data-inline-edit="{{ appointment.id }}"></div>
                {% if address %}
                    <form method="post" action="/vvs/tasks/{{ appointment.id }}/photos" enctype="multipart/form-data" class="form-grid">
                        <input type="hidden" name="date_query" value="{{ selected_date.isoformat() if selected_date else '' }}" />
                        <fieldset class="option-field" required>
                            <legend>Fototype</legend>
                            <div class="option-buttons">
                                <label class="option-button">
                                    <input type="radio" name="photo_type" value="both" required />
                                    <span>Begge målere i ét foto</span>
                                </label>
                                <label class="option-button">
                                    <input type="radio" name="photo_type" value="new" required />
                                    <span>Ny måler</span>
                                </label>
                                <label class="option-button">
                                    <input type="radio" name="photo_type" value="old" required />
                                    <span>Gammel måler</span>
                                </label>
                            </div>
                        </fieldset>
                        <label>Gammel målernr<input type="text" name="old_meter_no" /></label>
                        <label>Ny målernr<input type="text" name="new_meter_no" /></label>
                        <label>Foto<input type="file" name="file" accept="image/*" required /></label>
                        <button type="submit" class="primary-button">Upload</button>
                    </form>
                    {% if photos.get(appointment.id) %}
                        <div class="photo-grid">
                            {% for photo in photos.get(appointment.id) %}
                                <div class="photo-item">
                                    <img src="/upload/{{ photo.file_path }}" alt="{{ photo_labels.get(photo.photo_type, photo.photo_type) }}" class="photo-thumb" />
                                    <span>{{ photo_labels.get(photo.photo_type, photo.photo_type) }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <p class="hint">Ingen færdige opgaver endnu.</p>
    {% endif %}
</section>

<script src="/static/vvs_tasks.js" defer></script>
{% endblock %}
